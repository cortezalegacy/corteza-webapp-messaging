<template>
  <section>
      <header class="header">
        <label class="closer"
               @click.prevent="$router.back()"
               :aria-label="$t('channel.editor.closeTooltip')"><i class="icon-close"></i></label>
          <span class="title" v-if="channel.type === 'group' && channel.ID">{{ $t('channel.editor.editGroup') }}</span>
          <span class="title" v-else-if="channel.type === 'group'">{{ $t('channel.editor.createGroup') }}</span>
          <span class="title" v-else-if="channel.ID">{{ $t('channel.editor.editChannel') }}</span>
          <span class="title" v-else>{{ $t('channel.editor.createChannel') }}</span>
      </header>
      <main class="container">
        <form class="editor big-form" @submit.prevent="onSubmit" v-if="!channel.ID || channel.type !== 'group'">
          <div v-if="error" class="error">
            {{error}}
          </div>
<!--
          <div class="notification info no-margin">
              <p>Notifications ready to use ! Check assets/sass/README.MD for more info</p>
              <span class="close"></span>
          </div>
-->
          <div v-if="channel.type !== 'group'" class="input-wrap">
            <label class="label-block">{{ $t('channel.editor.channelNameLabel') }} *</label>
            <input
              class="input-txt input-block name"
              name="name"
              v-model.trim="channel.name"
              required
              :disabled="!channel.canUpdate"
              autocomplete="channel-name"
              :placeholder="$t('channel.editor.channelNamePlaceholder')">
          </div>

          <div v-if="channel.type !== 'group'" class="input-wrap">
            <label class="label-block">{{ $t('channel.editor.channelTopicLabel') }}</label>
            <input
              class="input-txt input-block"
              name="topic"
              v-model.trim="channel.topic"
              :disabled="!channel.canUpdate"
              autocomplete="channel-topic"
              :placeholder="$t('channel.editor.channelTopicPlaceholder')">
          </div>

          <div class="form-check" v-if="channel.type !== 'group'">
            <input
              class="input-chk"
              type="checkbox"
              id="channel-type"
              v-model="channel.type"
              :disabled="!channel.canUpdate"
              true-value="private"
              false-value="public">
            <label for="channel-type">
                {{ $t('channel.editor.channelPrivateLabel') }}
            </label>
          </div>

          <div class="selected-members">
            <label v-if="members.length > 0">{{ $t('channel.editor.selectedMemersLabel') }}</label>
            <ul>
              <li v-for="(u) in members" :key="u.ID">
                <user-avatar :user="u" />
                {{ label(u) }}
                <button class="btn-i" @click.prevent="channel.removeMember(u)"><i class="icon-close"></i></button>
              </li>
            </ul>
          </div>

          <div v-if="!channel.ID">
            <label class="label-block">{{ $t('channel.editor.addMembersLabel') }}</label>
            <vue-simple-suggest
              v-model="selectedMember"
              :list="nonMembers"
              :placeholder="$t('channel.editor.addMembersPlaceholder')"
              :filter-by-query="true"
              value-attribute="ID"
              display-attribute="name"
              @select="onMemberSelect"
              class="select-members"
              :destyled="true"
            />
          </div>

          <div class="actions">
            <button class="btn btn-green" v-if="channel.ID && channel.canUpdate">{{ $t('channel.editor.update') }}</button>
            <button class="btn btn-green" v-if="!channel.ID">{{ $t('channel.editor.create') }}</button>
            <button class="btn" @click.prevent="$router.back()">{{ $t('channel.editor.close') }}</button>
          </div>
        </form>

        <div v-if="channel.ID">
          <confirmation-row
            class="toggle-state"
            v-if="!channel.archivedAt && channel.canArchive"
            @confirmed="updateChannelState('archive')"
            cta="Archive">
            {{ $t('notification.channel.archiveChannel') }}
          </confirmation-row>

          <confirmation-row
            class="toggle-state"
            v-if="channel.archivedAt && channel.canArchive"
            @confirmed="updateChannelState('unarchive')"
            cta="Unarchive" ctaClass="info">
            {{ $t('notification.channel.unArchive') }}
          </confirmation-row>

          <confirmation-row
            class="toggle-state"
            v-if="!channel.deletedAt && channel.canDelete"
            @confirmed="updateChannelState('delete')"
            cta="Delete">
            {{ $t('notification.channel.delete') }}
          </confirmation-row>

          <confirmation-row
            class="toggle-state"
            v-if="channel.deletedAt && channel.canDelete"
            @confirmed="updateChannelState('undelete')"
            cta="Undelete" ctaClass="info">
            {{ $t('notification.channel.unDelete') }}
          </confirmation-row>
        </div>
      </main>
  </section>
</template>
<script>
import { Channel } from '@/types'
import { mapGetters, mapMutations } from 'vuex'
import ConfirmationRow from '@/components/Form/ConfirmationRow'
import SearchInput from '@/components/SearchInput'
import VueSimpleSuggest from 'vue-simple-suggest/lib/vue-simple-suggest'
import 'vue-simple-suggest/dist/styles.css'
import Avatar from '@/components/Avatar'

export default {
  name: 'channel-editor',

  components: {
    VueSimpleSuggest,
    SearchInput,
    ConfirmationRow,
    'user-avatar': Avatar,
  },

  props: ['channelID', 'type'],

  data () {
    return {
      channel: new Channel(),
      error: null,

      selectedMember: null,
      autoCompleteStyle: {
        vueSimpleSuggest: 'position-relative',
        inputWrapper: '',
        defaultInput: 'form-control',
        suggestions: 'position-absolute list-group z-1000',
        suggestItem: 'list-group-item',
      },
    }
  },

  computed: {
    ...mapGetters({
      users: 'users/list',
    }),

    nonMembers () {
      return this.users.filter(u => !this.channel.isMember(u.ID) && u.ID !== this.$auth.user.ID)
    },

    members () {
      return this.users.filter(u => this.channel.isMember(u.ID))
    },
  },

  watch: {
    'channelID' (newID) {
      this.load(newID)
    },

    'type' (newType) {
      if (!this.channel.ID) this.channel.type = newType
    },
  },

  mounted () {
    this.load(this.channelID)
  },

  methods: {
    ...mapMutations({
      removeChannelFromList: 'channels/removeFromList',
    }),

    load (channelID) {
      if (channelID) {
        this.$messaging.channelRead({ channelID }).then((ch) => {
          this.channel = ch

          this.$messaging.channelMembers({ channelID }).then((members) => {
            console.debug('Chanel member info loaded into editor', members)
            this.channel.members = members.map((m) => {
              return m.user.ID
            })
          })
        }).catch((error) => {
          console.error('Failed to load channel info', { error })
        }).finally(() => {
          // this.disabled = false
        })
      } else {
        this.channel = new Channel()
        if (this.type) {
          this.channel.type = this.type
        }
      }
    },

    // moving channels between deleted, undeleted, archived, unarchived states
    updateChannelState (state) {
      this.$messaging.channelState({ channelID: this.channel.ID, state }).then((ch) => {
        this.channel = ch
      }).catch(({ message }) => {
        this.error = message
      })
    },

    onSubmit () {
      if (this.channel.ID) {
        console.debug('Updating channel', this.channel)
        this.$messaging.channelUpdate({ ...this.channel, channelID: this.channel.ID }).then((ch) => {
          console.debug('Channel updated', ch)
          this.$router.push({ name: 'channel', params: { channelID: this.channelID } })
        }).catch((error) => {
          this.error = error.message
        })
      } else {
        console.debug('Creating channel', this.channel)
        this.$messaging.channelCreate(this.channel).then((ch) => {
          console.debug('Channel created', ch)
          this.$router.push({ name: 'channel', params: { channelID: ch.ID } })
        }).catch(({ error }) => {
          this.error = error
        })
      }
    },

    onMemberSelect (user) {
      this.selectedMember = ''
      this.channel.members.push(user.ID)
    },
  },
}
</script>

<style scoped lang="scss">
@import '@/assets/sass/inputs.scss';
@import '@/assets/sass/_0.commons.scss';
@import '@/assets/sass/headers.scss';
@import '@/assets/sass/btns.scss';
@import '@/assets/sass/notifications.scss';

.header {
  .title {
    padding-top: 15px;
  }
}

div.error {
  color: $appred;
}

form, main > section {
  padding: 10px;
}

form {
  .actions {
    text-align: center;
    margin-top: 15px;
    .btn {
      line-height: 16px;
    }
  }
}

section.toggle-state {
  border-top: 1px solid $appgrey;
  font-size: 1.5em;
  padding: 20px 10px 30px 10px;
  margin: 20px;
}

.default-input{
  font-size: 16px;
}

.closer {
  position: relative;
  color: $appgrey;
  float: right;
  font-size: 20px;
  font-weight: bold;
  top: 10px;
  right: 10px;
  cursor: pointer;
  line-height: 30px;
}

.label-block{
  font-weight: bold;
  padding-bottom: 10px;
}

.form-check{
  margin-bottom: 30px;
}

.btn{
  font-size: 14px;
}

ul {
  padding: 0;
  margin-top: 5px;
  li {
    list-style: none;
    display: inline-block;
    margin-right: 5px;
    vertical-align: bottom;
  }
}

.btn-i {
  padding: 0 10px 0 0;
  margin-top: -5px;
}
.select-members{
  /deep/ .input-wrapper{
    input{
      font-size: 16px;
      width: 100%;
      height: 42px;
      padding: 0 0.5em;
      border-radius: 3px;
      border: solid 1px #90A3B1;
      &::placeholder{
        color: #90A3B1;
      }
      &:focus{
        border: 1px solid #1397CB;
      }
    }
  }
  /deep/ .suggestions {
    position: absolute;
    background: $appcream;
    padding: 0 10px 20px 10px;
    overflow: scroll;
    max-height: 100px;
    .suggest-item {
      cursor: pointer;
      padding: 5px 0 0;
        &:hover {
          color: $appblue;
        }
    }
  }
}

</style>
